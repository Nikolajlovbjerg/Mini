@page "/mine-anmodninger/{AnnonceId:int}"
@inject HttpClient Http
@using Core;
@using PW1

<h3>Mine Anmodninger</h3>

@if (anmodninger == null)
{
    <p>Henter...</p>
}
else if (!anmodninger.Any())
{
    <p>Ingen anmodninger endnu.</p>
}
else
{
    <ul>
        @foreach (var a in anmodninger)
        {
            <li>
                <b>@a.AnnonceId</b> — @a.Status — @a.Date
                @if (a.Status == "pending")
                {
                    <button class="btn btn-success btn-sm"
                            @onclick="() => AcceptAndMove(a.AnmodningId)">
                        Accepter
                    </button>
                }
            </li>
        }
    </ul>
}

@code {
    [Parameter] public int AnnonceId { get; set; }
    private List<Anmodning>? anmodninger = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadAnmodninger();
    }

    private async Task LoadAnmodninger()
    {
        anmodninger = await Http.GetFromJsonAsync<List<Anmodning>>(
            $"http://localhost:{PASSWORD.localPort}/api/anmodning/byAnnonce/{AnnonceId}"
        );
    }

    private async Task Accept(int anmodningId)
    {
        await Http.PutAsync(
            $"http://localhost:{PASSWORD.localPort}/api/anmodning/accept/{AnnonceId}/{anmodningId}",
            null
        );

        await LoadAnmodninger(); // opdater listen
    }
    private async Task AcceptAndMove(int anmodningId)
    {
        await Http.PutAsync(
            $"http://localhost:{PASSWORD.localPort}/api/anmodning/acceptMove/{AnnonceId}/{anmodningId}",
            null
        );

        await LoadAnmodninger(); // opdater listen bagefter
    }
}