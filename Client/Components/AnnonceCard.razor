@using Core
@inject NavigationManager Nav
@namespace Client.Components.AnnonceCard

<article class="annonce-row" role="listitem">
    <div class="thumb">
        <img src="@Annonce.ImageUrl" alt="@Annonce?.Title" loading="lazy" />
    </div>

    <div class="content">
        <h3 class="title">@Annonce?.Title</h3>

        <div class="subtitle">
            <span class="where">Marked</span>
            <span class="price">til salg @Annonce?.Price.ToString("N0") kr.</span>
        </div>
    </div>

    <div class="actions">
        <button class="btn mark-sold" @onclick="OnClickSeeRequest">Se anmodninger</button>

        <!-- simpel dropdown: tabindex + onblur lukker ved klik udenfor -->
        <div class="rd-wrapper" tabindex="0" @onblur="CloseMenu">
            <button class="rd-btn" @onclick="Toggle">@ButtonText</button>

            @if (open)
            {
                <div class="rd-menu" @onclick:stopPropagation>
                    <button class="rd-item" @onclick="Edit">Rediger</button>
                    <button class="rd-item rd-delete" @onclick="Delete">Slet</button>
                </div>
            }
        </div>
    </div>
</article>

@code {
    [Parameter] public Annonce Annonce { get; set; } = default!;
    [Parameter] public EventCallback<int> OnDelete { get; set; }
    [Parameter] public EventCallback OnSeeRequests { get; set; }

    private bool open = false;
    private string ButtonText => "â€¦";

    private void Toggle()
    {
        open = !open;
    }

    private void CloseMenu(FocusEventArgs _)
    {
        open = false;
    }

    async Task Edit()
    {
        open = false;
        if (Annonce != null)
        {
            Nav.NavigateTo($"/annoncer/edit/{Annonce.AnonnceId}");
        }
    }

    async Task Delete()
    {
        open = false;
        if (OnDelete.HasDelegate) await OnDelete.InvokeAsync(Annonce.AnonnceId);
    }

    private async void OnClickSeeRequest()
    {
        
    }
}